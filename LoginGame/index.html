<!DOCTYPE html>
<html>
<head>
    <title></title>
	<meta charset="utf-8" />
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"></script>-->

    <link href="Content/bootstrap.css" rel="stylesheet" />
    <link href="Content/Site.css" rel="stylesheet" />
</head>
<body>

    <script src="Scripts/LoginGame/GameModel.js"></script>
    <script src="Scripts/LoginGame/Controllers.js"></script>
    <script src="Scripts/LoginGame/ViewModels.js"></script>
    <script src="Scripts/LoginGame/Presentation.js"></script>
    <script src="Scripts/Helpers/StringHelpers.js"></script>
    <script src="Scripts/pieTimer.js"></script>
    <div id="hiddenLayout" style="display:none">
        <div class="screenContainer text-center" style="width:0%">
            <div class="overallTime">
                <div class="row">
                    <div class="col-xs-2">
                    </div>
                    <div class="col-xs-8">
                        <div class="row screenTimer">
                            <div class="screenTime">
                            </div>
                        </div>
                    </div>                   
                </div>
            </div>
            <div class="controlsContainer registerPanel text-left" style="display:none">
                <!--<form onsubmit="submit(this); return false;">-->
                    <div class="row">
                        <div class="col-xs-2">
                        </div>
                        <div class="col-xs-8">
                            <div class="row panelTitle">
                                Register New Account
                            </div>
                            <div class="row">
                                <div class="col-xs-6">
                                    Username:
                                </div>
                                <div class="col-xs-6">
                                    <input type="text" class="inputUsername" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-6">
                                    Password:
                                </div>
                                <div class="col-xs-6">
                                    <input type="password" class="inputPassword" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-6">
                                    Confirm Password:
                                </div>
                                <div class="col-xs-6">
                                    <input type="password" class="inputConfirmPassword" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 alert alert-danger errors" style="display:none"></div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 text-right">
                                    <button type="button" onclick="submit(this)">Submit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                <!--</form>-->
            </div>

            <div class="controlsContainer loginPanel text-left" style="display:none">
                <div class="row">
                    <div class="col-xs-2">
                    </div>
                    <div class="col-xs-8">
                        <div class="row panelTitle">
                            Login
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                Username:
                            </div>
                            <div class="col-xs-6">
                                <input class="inputUsername" type="text" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                Password:
                            </div>
                            <div class="col-xs-6">
                                <input class="inputPassword" type="password" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 alert alert-danger errors" style="display:none"></div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 text-right">
                                <button type="button" onclick="submit(this)">Login</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controlsContainer successPanel text-left" style="display:none">
                <div class="row">
                    <div class="col-xs-2">
                    </div>
                    <div class="col-xs-8">
                        <div class="row panelTitle">
                            Successfully logged in!
                        </div>
                    </div>
                </div>
            </div>

            <div class="controlsContainer lockedPanel text-left" style="display:none">
                <div class="row">
                    <div class="col-xs-2">
                    </div>
                    <div class="col-xs-8">
                        <div class="row panelTitle">
                            You have been locked out!
                        </div>
                    </div>
                </div>
            </div>

            <div class="controlsContainer resetPanel text-left" style="display:none">
                <div class="row">
                    <div class="col-xs-2">
                    </div>
                    <div class="col-xs-8">
                        <div class="row panelTitle">
                            Reset Password
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                Old Password:
                            </div>
                            <div class="col-xs-6">
                                <input class="inputOldPassword" type="password" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                New Password:
                            </div>
                            <div class="col-xs-6">
                                <input class="inputNewPassword" type="password" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6">
                                Confirm New Password:
                            </div>
                            <div class="col-xs-6">
                                <input class="inputConfirmPassword" type="password" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 alert alert-danger errors" style="display:none"></div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 text-right">
                                <button type="button" onclick="submit(this)">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="screensContainer">

    </div>
    <div class="row">
        <div class="col-md-pull-6 gameOver" style="display:none; color: red;">
            GAME OVER...
        </div>
    </div>

    <script>


    //CONSTANTS
    var gameStates = ["Ready", "Active", "GameOver"]
    var screenStates = ["Register", "Login", "Success", "Locked", "Reset"]


    //key bindings
    $(document).bind('keydown', function (e) {
        if (e.keyCode == 13) {
            submit(document.activeElement);
        }
        if (e.keyCode == 88) { //x
            //ev_X_Press();
        }
        if (e.keyCode == 67) { //x
            //ev_C_Press();
        }
    });

    //key events
    var ev_X_Press = function () {
        var screen = gameController.AddLoginScreen(gameModel, new Screen(gameModel.numberOfLoginScreens));
        if (screen) {
            presentationModel.UpdateDisplay(gameModel);
            setInterval(
                updateLoginTime.bind(
                    this,
                    screen,
                    gameController,
                    gameModel,
                    presentationModel
                ),
                1000
            );
        }
    }
    
    //ev_X_Press();

    var updateLoginTime = function (screen, gameController, gameModel, presentationModel ) {
        gameController.UpdateRemainingLoginTime(screen, gameModel);
        presentationModel.handleGameOver(screen, gameModel.gameOver);
        presentationModel.updateRemainingLoginTimer(screen);
    }
    //var ev_C_Press = function () {
    //    gameController.TestResetScreen(gameModel, 0);
    //    presentationModel.UpdateDisplay(gameModel);
    //}
    var triggerReset = function(id){
        gameController.TestResetScreen(gameModel, id);
        presentationModel.UpdateDisplay(gameModel);
    }

    //start the game!
    var gameModel = gameModel || new Game();
    var screenController = new ScreenController();
    var policyController = new PolicyController();
    var presentationModel = presentationModel || new Presentation(screenController, policyController);
    var gameController = new GameController(gameModel, screenController, policyController, presentationModel);
    var newWindowInterval = setInterval(ev_X_Press, gameModel.AddScreenDelay * 1000);

    //submit catchall
    submit = function (button) {
        var screenContainer = $(button).parents('.screenContainer');
        var result;
        if ($(button).parents('.registerPanel').length > 0) {
            var registerpanel = $(screenContainer).find('.registerPanel');
            var matchingScreen = gameController.GetLoginScreen(gameModel, $(screenContainer).attr('id'));

            presentationModel.SubmitRegisterPanel(screenContainer, matchingScreen, registerpanel);
            presentationModel.UpdateDisplay(gameModel);
        }
        if ($(button).parents('.loginPanel').length > 0) {
            var loginpanel = $(screenContainer).find('.loginPanel');
            var matchingScreen = gameController.GetLoginScreen(gameModel, $(screenContainer).attr('id'));

            presentationModel.SubmitLoginPanel(screenContainer, matchingScreen, loginpanel, gameModel);
            if (matchingScreen.state == 'Locked') {
                gameModel.gameOver = true;
                presentationModel.handleGameOver(matchingScreen, gameModel);
            }
            if (matchingScreen.state == 'Success') {
                gameModel.successfulLogins += 1;
                matchingScreen.currentTimeLimit = 0;

                //spawn another login in two seconds
                if (gameModel.loginScreens.length < gameModel.maxNumberOfLoginScreens) {
                    clearInterval(newWindowInterval);
                    setTimeout(ev_X_Press, 1000);
                    newWindowInterval = setInterval(ev_X_Press, (gameModel.AddScreenDelay * 1000) + 1000);
                }
            }
            
            presentationModel.UpdateDisplay(gameModel);
        }
        if ($(button).parents('.resetPanel').length > 0) {
            var resetpanel = $(screenContainer).find('.resetPanel');
            var matchingScreen = gameController.GetLoginScreen(gameModel, $(screenContainer).attr('id'));

            presentationModel.SubmitResetPanel(screenContainer, matchingScreen, resetpanel);
            presentationModel.UpdateDisplay(gameModel);
        }
    }

    $('document').ready(function () {
        ev_X_Press();
    });

    </script>
</body>
</html>
